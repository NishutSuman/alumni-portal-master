import{j as t}from"./ui-o2EL3sck.js";import{e as de,r as n,L as h}from"./router-BgvBx64T.js";import{u as me,B as xe}from"./index-CR7i03R2.js";import{o as ge}from"./userApi-Mynrbi73.js";import{L as ue}from"./LoadingSpinner-Vtvv1Ip3.js";import{E as fe,a as he,R as pe,Q as ye,I as ve,T as je}from"./TicketModal-BRzrLyTF.js";import{F as Ne}from"./PlusIcon-CFkNWmzL.js";import{F as P}from"./CalendarIcon-D1CEt3gK.js";import{F as we}from"./ClockIcon-53QLE2kZ.js";import{F as be}from"./MapPinIcon-DXK1xInM.js";import{F as Ee}from"./UsersIcon-B-AjT4um.js";import{F as ke}from"./CurrencyRupeeIcon-DmDbs4Pp.js";import{F as D}from"./EyeIcon-DLMljlLJ.js";import{F as q}from"./PencilIcon-CGtBlyj4.js";import{f as De}from"./utils-CXyNmL__.js";import"./redux-BejLzyCF.js";import"./vendor-c5ypKtDW.js";import"./XMarkIcon-B58Eb0hU.js";import"./index.esm-Cslq-b9M.js";import"./UserIcon-Bm6z4MZR.js";import"./DocumentTextIcon-CP6_YxxS.js";import"./ArrowDownTrayIcon-BpYFy8xY.js";const We=()=>{const{hasRole:O,user:c,auth:p}=me(),y=O("SUPER_ADMIN"),[R]=de(),[o,m]=n.useState("active");n.useEffect(()=>{const e=R.get("tab");e&&["active","booked","past"].includes(e)&&m(e)},[R]);const[C,v]=n.useState(null),[s,S]=n.useState(null),[z,M]=n.useState(!1),[U,I]=n.useState(!1),[V,F]=n.useState(!1),[Q,x]=n.useState(!1),[B,d]=n.useState(!1),[G,j]=n.useState(!1),[_,g]=n.useState(null),[H,N]=n.useState(null),[Y,T]=n.useState(!1),[J,w]=n.useState(null),{data:K,isLoading:W,error:X}=xe({page:1,limit:50,upcoming:void 0}),{data:Z,isLoading:Re,error:Ce}=ge({page:1,limit:50}),b=K?.events||[],E=Z?.registrations||[],u=new Date,$=new Set(E.map(e=>e.event?.id).filter(Boolean));let f;o==="booked"?f=E.filter(e=>e.event).map(e=>({...e.event,registration:e,hasQRCode:!!e.qr,totalGuests:e.guests?.length||0,registrationStatus:e.status,paymentStatus:e.paymentStatus,mealPreference:e.mealPreference,registrationDate:e.createdAt,qrCode:e.qr})):f=b.filter(e=>{const a=new Date(e.eventDate);return o==="active"?a>=u&&!["COMPLETED","CANCELLED"].includes(e.status):a<u||["COMPLETED","CANCELLED"].includes(e.status)});const ee=(e,a,r)=>{const l=new Date(e),i=De(l,"MMM dd, yyyy");return a&&r?`${i} • ${a} - ${r}`:a?`${i} • ${a}`:i},A=e=>{switch(e){case"VIRTUAL":return"bg-blue-100 text-blue-800";case"HYBRID":return"bg-purple-100 text-purple-800";default:return"bg-green-100 text-green-800"}},te=e=>{switch(e){case"PUBLISHED":case"REGISTRATION_OPEN":return"bg-green-100 text-green-800";case"REGISTRATION_CLOSED":return"bg-yellow-100 text-yellow-800";case"COMPLETED":return"bg-gray-100 text-gray-800";case"CANCELLED":return"bg-red-100 text-red-800";case"DRAFT":return"bg-orange-100 text-orange-800";default:return"bg-gray-100 text-gray-800"}},L=e=>{v(e),M(!0)},ae=e=>{v(e),I(!0)},se=e=>{const a=E.find(r=>r.event?.id===e.id);a&&(S(a),F(!0))},k=()=>{v(null),S(null),g(null),N(null),w(null),M(!1),I(!1),F(!1),x(!1),d(!1),j(!1)},re=()=>{g(null),x(!1)},ne=()=>{N(null),d(!1)},oe=()=>{w(null),j(!1)},ie=async()=>{if(s?.paymentTransaction?.id){T(!0),d(!0);try{const[e,a]=await Promise.all([fetch(`http://localhost:3000/api/payments/${s.paymentTransaction.id}/invoice`,{headers:{Authorization:`Bearer ${p.token||localStorage.getItem("token")}`}}),fetch("http://localhost:3000/api/organization",{headers:{Authorization:`Bearer ${p.token||localStorage.getItem("token")}`}})]);if(e.ok){const r=await e.json();let l={name:"Alumni Portal Organization",officialEmail:"admin@alumniportal.com",officeAddress:"Organization Address"};if(a.ok)try{const i=await a.json();i.data?.organization&&(l={name:i.data.organization.name||l.name,officialEmail:i.data.organization.officialEmail||l.officialEmail,officeAddress:i.data.organization.officeAddress||l.officeAddress,logoUrl:i.data.organization.logoUrl})}catch(i){console.warn("Failed to parse organization data:",i)}N({invoice:r.data.invoice,transaction:s.paymentTransaction,registration:s,user:c,organization:l})}else console.error("Failed to fetch invoice data"),alert("Failed to load invoice. Please try again."),d(!1)}catch(e){console.error("Error fetching invoice:",e),alert("Failed to load invoice. Please try again."),d(!1)}finally{T(!1)}}else s?.totalAmount===0?alert("This is a free event. No invoice is available."):alert("No payment transaction found for this registration.")},le=async()=>{if(s?.qr?.qrCode)g({qrCode:s.qr.qrCode,qrImageUrl:s.qr.qrImageUrl,event:{title:s.event.title,eventDate:s.event.eventDate,venue:s.event.venue},user:{fullName:c?.fullName||"User",email:c?.email||"user@example.com"},registrationId:s.id}),x(!0);else try{const e=`http://localhost:3000/api/events/${s.event.id}/my-registration/qr-code`,a=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${p.token||localStorage.getItem("token")}`,"Content-Type":"application/json"}});if(a.ok){const r=await a.json(),l={qrCode:r.data?.qrCode||r.qrCode,qrImageUrl:r.data?.qrImageUrl||r.qrImageUrl,event:{title:s.event.title,eventDate:s.event.eventDate,venue:s.event.venue},user:{fullName:c?.fullName||"User",email:c?.email||"user@example.com"},registrationId:s.id};g(l),x(!0)}else{const r=await a.text();console.error("Failed to generate QR code:",a.status,r),alert(`Failed to generate QR code: ${a.status} - ${r}`)}}catch(e){console.error("Error generating QR code:",e),alert("Failed to generate QR code. Please try again.")}},ce=()=>{s&&(w({registration:s,user:c,organization:{name:"Alumni Portal Organization"}}),j(!0))};return W?t.jsx(ue,{}):X?t.jsxs("div",{className:"text-center py-12",children:[t.jsx("div",{className:"text-red-500 mb-4",children:"Failed to load events"}),t.jsx("button",{onClick:()=>window.location.reload(),className:"btn-guild",children:"Try Again"})]}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Events"}),t.jsx("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:"View and manage all alumni events"})]}),y&&t.jsx("div",{className:"mt-4 sm:mt-0",children:t.jsxs(h,{to:"/admin/events-management",className:"btn-guild inline-flex items-center",children:[t.jsx(Ne,{className:"h-5 w-5 mr-2"}),"Manage Events"]})})]}),t.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700",children:t.jsxs("nav",{className:"-mb-px flex space-x-8",children:[t.jsxs("button",{onClick:()=>m("active"),className:`py-2 px-1 border-b-2 font-medium text-sm ${o==="active"?"border-guild-500 text-guild-600 dark:text-guild-400":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300"}`,children:["Active Events",t.jsx("span",{className:"ml-2 bg-guild-100 text-guild-600 py-0.5 px-2 rounded-full text-xs",children:b.filter(e=>new Date(e.eventDate)>=u&&!["COMPLETED","CANCELLED"].includes(e.status)).length})]}),t.jsx("button",{onClick:()=>m("booked"),className:`py-2 px-1 border-b-2 font-medium text-sm ${o==="booked"?"border-guild-500 text-guild-600 dark:text-guild-400":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300"}`,children:"Your Bookings"}),t.jsxs("button",{onClick:()=>m("past"),className:`py-2 px-1 border-b-2 font-medium text-sm ${o==="past"?"border-guild-500 text-guild-600 dark:text-guild-400":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300"}`,children:["Past Events",t.jsx("span",{className:"ml-2 bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs",children:b.filter(e=>new Date(e.eventDate)<u||["COMPLETED","CANCELLED"].includes(e.status)).length})]})]})}),f.length===0?t.jsxs("div",{className:"text-center py-12",children:[t.jsx(P,{className:"mx-auto h-12 w-12 text-gray-400"}),t.jsxs("h3",{className:"mt-2 text-sm font-medium text-gray-900 dark:text-white",children:["No ",o==="booked"?"booked":o," events"]}),t.jsx("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:o==="active"?"There are no upcoming events at the moment.":o==="booked"?"You haven't registered for any events yet.":"No past events to display."}),o==="active"&&t.jsx("div",{className:"mt-6",children:t.jsx(h,{to:"/admin/events-management",className:"btn-guild",children:"Create Your First Event"})})]}):t.jsx("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3",children:f.map(e=>t.jsxs("div",{className:"bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow duration-200",children:[e.heroImage&&t.jsx("div",{className:"aspect-w-16 aspect-h-9",children:t.jsx("img",{src:`http://localhost:3000/api/events/${e.id}/hero-image`,alt:e.title,className:"w-full h-48 object-cover",onError:a=>{console.error("Event image failed to load:",e.heroImage),console.error("Proxy URL:",`http://localhost:3000/api/events/${e.id}/hero-image`),console.error("Error details:",a),a.target.style.display="none"},onLoad:()=>{console.log("Event image loaded successfully via proxy:",`http://localhost:3000/api/events/${e.id}/hero-image`)}})}),t.jsxs("div",{className:"p-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.category&&t.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200",children:e.category.name}),t.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${te(e.status)}`,children:e.status.replace("_"," ")})]}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:e.title}),t.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-4 line-clamp-2",children:e.description}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center text-sm text-gray-500 dark:text-gray-400",children:[t.jsx(P,{className:"flex-shrink-0 mr-2 h-4 w-4"}),ee(e.eventDate,e.startTime,e.endTime)]}),t.jsx("div",{className:"flex items-center text-sm text-gray-500 dark:text-gray-400",children:e.eventMode==="VIRTUAL"?t.jsxs(t.Fragment,{children:[t.jsx(we,{className:"flex-shrink-0 mr-2 h-4 w-4"}),t.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${A(e.eventMode)}`,children:"Virtual Event"})]}):t.jsxs(t.Fragment,{children:[t.jsx(be,{className:"flex-shrink-0 mr-2 h-4 w-4"}),t.jsx("span",{className:"truncate",children:e.venue||"Venue TBA"}),e.eventMode==="HYBRID"&&t.jsx("span",{className:`ml-2 px-2 py-1 rounded-full text-xs ${A(e.eventMode)}`,children:"Hybrid"})]})}),e.maxCapacity&&t.jsxs("div",{className:"flex items-center text-sm text-gray-500 dark:text-gray-400",children:[t.jsx(Ee,{className:"flex-shrink-0 mr-2 h-4 w-4"}),e._count?.registrations||e.registrationCount||0," / ",e.maxCapacity," registered"]}),Number(e.registrationFee)>0&&t.jsxs("div",{className:"flex items-center text-sm text-gray-500 dark:text-gray-400",children:[t.jsx(ke,{className:"flex-shrink-0 mr-2 h-4 w-4"}),"₹",e.registrationFee,Number(e.guestFee)>0&&t.jsxs("span",{className:"text-xs ml-1",children:["(Guest: ₹",e.guestFee,")"]})]})]}),t.jsx("div",{className:"mt-4 space-y-2",children:o==="active"?t.jsxs(t.Fragment,{children:[["PUBLISHED","REGISTRATION_OPEN"].includes(e.status)&&!$.has(e.id)&&t.jsx("button",{className:"w-full btn-guild text-sm",onClick:()=>ae(e),children:"Register Now"}),$.has(e.id)&&t.jsx("div",{className:"w-full text-center py-2 bg-green-100 text-green-800 rounded-md text-sm font-medium",children:"✓ Already Registered"}),t.jsxs("div",{className:"flex space-x-2",children:[t.jsxs("button",{className:"flex-1 btn-secondary text-sm inline-flex items-center justify-center",onClick:()=>L(e),children:[t.jsx(D,{className:"h-4 w-4 mr-1"}),"View Details"]}),y&&t.jsxs(h,{to:`/admin/events-management?edit=${e.id}`,className:"flex-1 btn-secondary text-sm inline-flex items-center justify-center",children:[t.jsx(q,{className:"h-4 w-4 mr-1"}),"Edit"]})]})]}):o==="booked"?t.jsxs("button",{className:"w-full btn-guild text-sm inline-flex items-center justify-center",onClick:()=>se(e),children:[t.jsx(D,{className:"h-4 w-4 mr-1"}),"View Registration Details"]}):t.jsxs("div",{className:"flex space-x-2",children:[t.jsxs("button",{className:"flex-1 btn-secondary text-sm inline-flex items-center justify-center",onClick:()=>L(e),children:[t.jsx(D,{className:"h-4 w-4 mr-1"}),"View Event"]}),y&&t.jsxs(h,{to:`/admin/events-management?edit=${e.id}`,className:"flex-1 btn-secondary text-sm inline-flex items-center justify-center",children:[t.jsx(q,{className:"h-4 w-4 mr-1"}),"Edit"]})]})})]})]},e.id))}),t.jsx(fe,{event:C,isOpen:z,onClose:k}),t.jsx(he,{event:C,isOpen:U,onClose:k}),t.jsx(pe,{registration:s,isOpen:V,onClose:k,onViewInvoice:ie,onViewQR:le,onViewTicket:ce}),t.jsx(ye,{isOpen:Q,onClose:re,qrData:_}),t.jsx(ve,{isOpen:B,onClose:ne,isLoading:Y,invoiceData:H}),t.jsx(je,{isOpen:G,onClose:oe,ticketData:J})]})};export{We as default};
//# sourceMappingURL=Events-B9gBdLvy.js.map
